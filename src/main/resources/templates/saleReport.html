<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sale Report</title>
  <style>
    :root{
      --header:#6673ff;
      --row-alt:#f5f3ff;
      --text:#334155;
      --muted:#64748b;
      --shadow: 0 12px 30px rgba(17,24,39,.10);
      --radius: 14px;
    }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:#f7f7fb;
      color:var(--text);
      padding:24px;
    }
    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px;
      flex-wrap:wrap;
    }
    .title{
      font-size:20px;
      font-weight:900;
      color:#0f172a;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .meta{
      font-size:13px;
      color:var(--muted);
      margin-top:4px;
    }
    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    select, button{
      border:1px solid #e5e7eb;
      border-radius:10px;
      padding:10px 12px;
      font-size:14px;
      background:#fff;
      cursor:pointer;
    }
    input.search{
      border:1px solid #e5e7eb;
      border-radius:10px;
      padding:10px 12px;
      font-size:14px;
      background:#fff;
      width:260px;
    }
    button.primary{
      background: var(--header);
      color:#fff;
      border:none;
      font-weight:800;
    }
    button.ghost{ background:#fff; font-weight:800; }

    .alert{
      padding:12px 14px;
      border-radius:12px;
      background:#fff;
      border:1px solid #e5e7eb;
      margin:12px 0;
      font-size:14px;
    }
    .alert.error{ border-color:#fecaca; background:#fff1f2; color:#991b1b; }

    .table-card{
      background:#fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      width: 1800px;
      margin-left: -200px;
    }
    .table-scroll{
      max-height: 78vh;
      overflow:auto;
    }
    table{ width:100%; border-collapse: collapse; min-width: 1200px; }
    thead th{
      background: var(--header);
      color:#fff;
      text-align:left;
      font-weight:900;
      padding: 14px 16px;
      position: sticky;
      top:0;
      z-index:2;
      white-space:nowrap;
      cursor: default;
    }
    thead th.sortable{ cursor:pointer; }
    thead th .sort-indicator{ margin-left:8px; font-size:12px; opacity:0.9 }
    tbody td{
      padding: 12px 16px;
      border-top:1px solid #eef2ff;
      font-size:14px;
      vertical-align:middle;
      white-space:nowrap;
    }
    tbody tr:nth-child(even){ background: var(--row-alt); }
    tbody tr:hover{ background:#edeaff; }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; }
    .center{ text-align:center; }

    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      color:#fff;
    }
    .pill.green{ background:#16a34a; }
    .pill.orange{ background:#f97316; }
    .pill.red{ background:#ef4444; }

    .no-token{
      max-width: 720px;
      margin: 80px auto 0;
      background:#fff;
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 24px;
      text-align:center;
    }
    .no-token a{ color: var(--header); text-decoration:none; font-weight:900; }
    /* Header styles copied from stats.html to provide consistent page header */
    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      /* make header span full viewport width despite body padding */
      /* margin:-50px;
      padding: 1rem 24px; */
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
      height: 78px;
      margin-top: -25px;
      margin-left: -50px;
      width: 2000px;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
    .header-content { display: flex; justify-content: space-between; align-items: center; padding-top: 10px;}
    .logo { font-size: 1.8rem; font-weight: bold; }
    nav ul { list-style: none; display: flex; gap: 1rem; }
    nav a { color: white; text-decoration: none; transition: opacity 0.3s; font-weight: 500; }
    nav a:hover { opacity: 0.8; }
    .content-section { padding: 2rem 0; }
    .section-title { font-size: 1.4rem; margin-bottom: 1rem; color: #667eea; display:flex; align-items:center; gap:0.5rem }
    
    /* Loading popup */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .loading-content {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-overlay.hidden {
      display: none;
    }
  </style>
</head>

<body>
<header>
  <div class="container">
    <div class="header-content">
      <div class="logo">üìä MeraGroup</div>
      <nav>
        <ul>
          <!-- <li><a href="/">Trang Ch·ªß</a></li> -->
          <!-- <li><a href="/config">C·∫•u H√¨nh</a></li> -->
          <li><a href="/stats" style="font-size: 25px;">CSKH</a></li>
        </ul>
      </nav>
    </div>
  </div>
</header>

<!-- Loading popup -->
<div id="loadingOverlay" class="loading-overlay hidden">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <div>ƒêang t·∫£i d·ªØ li·ªáu...</div>
  </div>
</div>

<div id="noTokenSection" class="no-token" style="display:none;">
  <h2 style="margin:0 0 10px 0;">Ch∆∞a c√≥ token üòµ‚Äçüí´</h2>
  <div style="color:var(--muted)">ƒêƒÉng nh·∫≠p Lark tr∆∞·ªõc r·ªìi quay l·∫°i trang report nha.</div>
  <div style="margin-top:14px;">
    <a href="/">üëâ V·ªÅ trang ƒëƒÉng nh·∫≠p</a>
  </div>
</div>

<div id="contentSection" style="display:none;">
  <section class="content-section">
    <div class="container">
  <div class="topbar">
    <div>
      <div class="title">üìà Sale Report (T·ªïng h·ª£p theo t∆∞ v·∫•n vi√™n)</div>
      <div class="meta" id="metaInfo">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>

    <div class="actions">
      <input id="searchInput" class="search" type="search" placeholder="T√¨m theo t√™n t∆∞ v·∫•n vi√™n" />

      <form method="get" action="/saleReport" id="rangeForm">
        <select name="range" id="rangeSelect">
          <option value="CurrentMonth" id="optCurrentMonth">Th√°ng n√†y</option>
          <option value="LastMonth" id="optLastMonth">Th√°ng tr∆∞·ªõc</option>
        </select>
        <button class="ghost" type="submit">L·ªçc</button>
      </form>

      <form method="post" action="/saleReport/refresh" id="refreshForm">
        <input type="hidden" name="range" id="refreshRange" />
        <button class="primary" type="submit">üîÑ L√†m m·ªõi d·ªØ li·ªáu</button>
      </form>

      <a href="#" id="exportExcelBtn" class="primary" style="text-decoration: none; display: inline-block; padding: 10px 20px; border-radius: 8px; background: #28a745; color: white; border: none; cursor: pointer; font-size: 14px; font-weight: 500;">
        üì• Xu·∫•t Excel
      </a>
    </div>
  </div>

  <div id="errorAlert" class="alert error" style="display:none;">
    <b>L·ªói:</b> <span id="errorText"></span>
  </div>

  <div class="table-card">
    <div class="table-scroll">
      <table>
        <thead>
        <tr>
          <th style="width:70px;">#</th>
          <th style="min-width:220px;">T∆∞ v·∫•n vi√™n</th>
          <th class="center">Nhu c·∫ßu</th>
          <th class="center">Tr√πng</th>
          <th class="center">R√°c</th>
          <th class="center">Kh√¥ng t∆∞∆°ng t√°c</th>
          <th class="center">Ch·ªët n√≥ng</th>
          <th class="center">Ch·ªët c≈©</th>
          <th class="center">ƒê∆°n h·ªßy</th>
          <th class="center" title="T·ªïng mess = Nhu c·∫ßu + Tr√πng + R√°c + Kh√¥ng t∆∞∆°ng t√°c + Ch·ªët n√≥ng + Ch·ªët c≈© + ƒê∆°n h·ªßy">T·ªïng mess</th>
          <th class="center" title="T·ªïng ƒë∆°n = Ch·ªët n√≥ng + Ch·ªët c≈©">T·ªïng ƒë∆°n</th>
          <th class="center" title="ƒê∆°n/mess nhu c·∫ßu = T·ªïng ƒë∆°n / (Nhu c·∫ßu + Ch·ªët n√≥ng + Ch·ªët c≈© + H·ªßy)">ƒê∆°n/mess nhu c·∫ßu</th>
          <th class="center" title="ƒê∆°n/mess t·ªïng = T·ªïng ƒë∆°n / T·ªïng mess">ƒê∆°n/mess t·ªïng</th>
          <th class="center" title="T·ªâ l·ªá h·ªßy = ƒê∆°n h·ªßy / T·ªïng ƒë∆°n">T·ªâ l·ªá h·ªßy</th>
          <!-- <th style="min-width:220px;">Table ID</th> -->
        </tr>
        </thead>

        <tbody id="tableBody">
        <!-- Data will be populated by JavaScript -->
        </tbody>
      </table>
    </div>
  </div>
    </div>
  </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const table = document.querySelector('.table-card table');
  if(!table) return;
  const tbody = table.querySelector('tbody');
  let rows = Array.from(tbody.querySelectorAll('tr')).filter(r=> r.querySelectorAll('td').length>0);
  const originalRows = rows.slice();
  const searchInput = document.getElementById('searchInput');
  const optCurrentMonth = document.getElementById('optCurrentMonth');
  const optLastMonth = document.getElementById('optLastMonth');

  // C·∫≠p nh·∫≠t label th√°ng ƒë·ªông
  const now = new Date();
  const currentMonth = now.getMonth() + 1; // 1-12
  const lastMonth = currentMonth === 1 ? 12 : currentMonth - 1;
  if (optCurrentMonth) optCurrentMonth.textContent = `Th√°ng ${currentMonth}`;
  if (optLastMonth) optLastMonth.textContent = `Th√°ng ${lastMonth}`;

  const ths = Array.from(table.querySelectorAll('thead th'));
  ths.forEach((th, idx)=>{
    if(idx===0) return; // skip index column
    th.classList.add('sortable');
    const span = document.createElement('span');
    span.className = 'sort-indicator';
    th.appendChild(span);
    th.dataset.sortState = 'none';
    th.addEventListener('click', ()=>{
      const state = th.dataset.sortState;
      const next = state==='none' ? 'asc' : state==='asc' ? 'desc' : 'none';
      ths.forEach(t=>{ if(t!==th){ t.dataset.sortState='none'; const si = t.querySelector('.sort-indicator'); if(si) si.textContent=''; }});
      th.dataset.sortState = next;
      const ind = th.querySelector('.sort-indicator');
      if(ind) ind.textContent = next==='asc' ? '‚ñ≤' : next==='desc' ? '‚ñº' : '';
      if(next==='none'){
        restoreOriginalOrder();
        applyFilter();
      } else {
        sortByColumn(idx, next);
      }
    });
  });

  function parseCellValue(text){
    if(!text) return '';
    const cleaned = text.replace('%','').trim();
    if(cleaned==='') return '';
    // X·ª≠ l√Ω s·ªë d·∫°ng 1.234,5% -> 1234.5 ƒë·ªÉ sort ƒë√∫ng
    const normalized = cleaned.replace(/\./g,'').replace(',', '.');
    const n = parseFloat(normalized);
    if(!isNaN(n)) return n;
    return cleaned.toLowerCase();
  }

  function sortByColumn(idx, order){
    const visible = rows.filter(r=> r.style.display !== 'none');
    visible.sort((a,b)=>{
      const aV = parseCellValue((a.children[idx]||{}).textContent||'');
      const bV = parseCellValue((b.children[idx]||{}).textContent||'');
      if(typeof aV === 'number' && typeof bV === 'number'){
        return order==='asc' ? aV - bV : bV - aV;
      } else {
        return order==='asc' ? String(aV).localeCompare(String(bV)) : String(bV).localeCompare(String(aV));
      }
    });
    const hidden = originalRows.filter(r=> r.style.display === 'none');
    tbody.innerHTML = '';
    visible.forEach(r=> tbody.appendChild(r));
    hidden.forEach(r=> tbody.appendChild(r));
  }

  function restoreOriginalOrder(){
    tbody.innerHTML = '';
    originalRows.forEach(r=> tbody.appendChild(r));
    rows = Array.from(tbody.querySelectorAll('tr')).filter(r=> r.querySelectorAll('td').length>0);
  }

  function applyFilter(){
    const q = (searchInput ? searchInput.value : '').trim().toLowerCase();
    rows.forEach(r=>{
      const nameCell = r.children[1];
      const text = nameCell ? nameCell.textContent.toLowerCase() : '';
      r.style.display = q === '' || text.indexOf(q) !== -1 ? '' : 'none';
    });
    const activeTh = ths.find(t=> t.dataset.sortState && t.dataset.sortState!=='none');
    if(activeTh){
      sortByColumn(ths.indexOf(activeTh), activeTh.dataset.sortState);
    }
  }

  if(searchInput){
    searchInput.addEventListener('input', ()=>{ applyFilter(); });
  }

});

// Load data from API
(async function() {
  const loadingOverlay = document.getElementById('loadingOverlay');
  const noTokenSection = document.getElementById('noTokenSection');
  const contentSection = document.getElementById('contentSection');
  const tableBody = document.getElementById('tableBody');
  const metaInfo = document.getElementById('metaInfo');
  const errorAlert = document.getElementById('errorAlert');
  const errorText = document.getElementById('errorText');
  const rangeSelect = document.getElementById('rangeSelect');
  const refreshRange = document.getElementById('refreshRange');
  
  // Get range from URL params
  const urlParams = new URLSearchParams(window.location.search);
  const range = urlParams.get('range') || 'CurrentMonth';
  rangeSelect.value = range;
  refreshRange.value = range;
  
  // Show loading
  loadingOverlay.classList.remove('hidden');
  
  try {
    const response = await fetch(`/api/saleReport/data?range=${encodeURIComponent(range)}`);
    const data = await response.json();
    
    loadingOverlay.classList.add('hidden');
    
    if (!data.hasToken) {
      noTokenSection.style.display = 'block';
      return;
    }
    
    contentSection.style.display = 'block';
    
    if (data.error) {
      errorAlert.style.display = 'block';
      errorText.textContent = data.error;
      return;
    }
    
    // Update meta info
    let metaHtml = '';
    if (data.fetchedAt) {
      metaHtml += ` ‚Ä¢ Th·ªëng k√™ l·∫ßn cu·ªëi: <b>${data.fetchedAt}</b>`;
    }
    if (data.totalAgents != null) {
      metaHtml += ` ‚Ä¢ T∆∞ v·∫•n vi√™n: <b>${data.totalAgents}</b>`;
    }
    metaInfo.innerHTML = metaHtml;
    
    // Render table
    if (data.rows && data.rows.length > 0) {
      tableBody.innerHTML = '';
      data.rows.forEach((row, index) => {
        const tr = document.createElement('tr');
        const tiLeHuy = row.tiLeHuyPercent || 0;
        const tiLeHuyClass = tiLeHuy < 10 ? 'green' : 'red';
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${escapeHtml(row.tableName || '-')}</td>
          <td class="center">${formatNumber(row.nhuCau || 0)}</td>
          <td class="center">${formatNumber(row.trung || 0)}</td>
          <td class="center">${formatNumber(row.rac || 0)}</td>
          <td class="center">${formatNumber(row.khongTuongTac || 0)}</td>
          <td class="center">${formatNumber(row.chotNong || 0)}</td>
          <td class="center">${formatNumber(row.chotCu || 0)}</td>
          <td class="center">${formatNumber(row.donHuy || 0)}</td>
          <td class="center">${formatNumber(row.tongMess || 0)}</td>
          <td class="center">${formatNumber(row.tongDon || 0)}</td>
          <td class="center">
            <span class="center">${formatPercent(row.donPerMessNhuCau || 0)}</span>
          </td>
          <td class="center">
            <span class="center">${formatPercent(row.donPerMessTong || 0)}</span>
          </td>
          <td class="center">
            <span class="pill ${tiLeHuyClass}">${formatPercent(tiLeHuy)}</span>
          </td>
        `;
        tableBody.appendChild(tr);
      });
      
      // Reinitialize table functionality
      setTimeout(() => {
        const tbody = document.querySelector('tbody');
        if (tbody) {
          rows = Array.from(tbody.querySelectorAll('tr')).filter(r => r.querySelectorAll('td').length > 0);
          originalRows = rows.map(r => r.cloneNode(true));
        }
      }, 100);
    } else {
      tableBody.innerHTML = '<tr><td colspan="14" style="text-align:center;padding:2rem;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
    }
    
  } catch (error) {
    loadingOverlay.classList.add('hidden');
    contentSection.style.display = 'block';
    errorAlert.style.display = 'block';
    errorText.textContent = 'L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message;
  }
})();

function formatNumber(num) {
  return new Intl.NumberFormat('vi-VN').format(num);
}

function formatPercent(num) {
  return num.toFixed(1).replace('.', ',') + '%';
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Export Excel functionality
document.addEventListener('DOMContentLoaded', function() {
  const exportBtn = document.getElementById('exportExcelBtn');
  if (exportBtn) {
    exportBtn.addEventListener('click', function(e) {
      e.preventDefault();
      const urlParams = new URLSearchParams(window.location.search);
      const range = urlParams.get('range') || 'CurrentMonth';
      const exportUrl = `/saleReport/export?range=${encodeURIComponent(range)}`;
      
      // T·∫°o link t·∫°m ƒë·ªÉ download
      const link = document.createElement('a');
      link.href = exportUrl;
      link.download = '';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  }
});
</script>

</body>
</html>
