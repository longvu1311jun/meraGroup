<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra cứu khách hàng</title>
    <style>
body{ font-family: Arial, Helvetica, sans-serif; background:#f6f7fb; color:#222; }
.container{ max-width:1000px; margin:30px auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.06);} 
h1{ margin:0 0 12px; font-size:20px; }
.search{ display:flex; gap:8px; margin-bottom:12px; }
input#phoneInput{ flex:1; padding:8px 10px; font-size:14px; border:1px solid #ccc; border-radius:4px; }
button#searchBtn, button#clearBtn{ padding:8px 12px; font-size:14px; border:none; background:#2563eb; color:#fff; border-radius:4px; cursor:pointer; }
button#clearBtn{ background:#6b7280 }
button#searchBtn:hover{ background:#1e4fd8 }
button#clearBtn:hover{ background:#565e66 }

.panel{ margin-top:12px; border-top:1px solid #eee; }
.panel-head{ display:flex; align-items:center; justify-content:space-between; padding:8px 0; }
.panel-head h2{ margin:0; font-size:16px; }
.toggle-btn{ background:#e5e7eb; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:16px; }
.panel-body{ padding:8px 0; }
.panel-body.collapsed{ display:none; }

.data-table{ width:100%; border-collapse:collapse; }
.data-table th, .data-table td{ border:1px solid #eee; padding:8px; text-align:left; font-size:14px; }
.data-table thead th{ background:#fafafa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tra cứu khách hàng theo số điện thoại</h1>
        <div class="search">
            <input id="phoneInput" type="text" placeholder="Nhập số điện thoại..." />
            <button id="searchBtn">Tra cứu</button>
            <button id="clearBtn" title="Hiển thị tất cả">Xóa</button>
        </div>
        <div id="searchInfo" style="margin-top:8px; padding:8px; background:#f0f0f0; border-radius:4px; font-size:13px; color:#666; display:none;">
            <span>⏰ Thời gian tra cứu: <strong id="searchTimeText">-</strong></span>
            <span style="margin-left:16px;">⚡ Thời gian phản hồi: <strong id="responseTimeText">-</strong></span>
        </div>

        <section class="panel">
            <header class="panel-head">
                <h2>Khách hàng</h2>
                <button class="toggle-btn" data-target="customersSection">−</button>
            </header>
            <div id="customersSection" class="panel-body"></div>
        </section>

        <section class="panel">
            <header class="panel-head">
                <h2>Ghi chú</h2>
                <button class="toggle-btn" data-target="notesSection">−</button>
            </header>
            <div id="notesSection" class="panel-body"></div>
        </section>

        <section class="panel">
            <header class="panel-head">
                <h2>Lịch hẹn trao đổi</h2>
                <button class="toggle-btn" data-target="appointmentsSection">−</button>
            </header>
            <div id="appointmentsSection" class="panel-body"></div>
        </section>
    </div>
        <script>
let customers = [];
let notes = [];
let appointments = [];

function normalizePhone(s){ return (s||'').replace(/\D/g,''); }

function createTable(headers){
    const table = document.createElement('table');
    table.className = 'data-table';
    const thead = document.createElement('thead');
    const tr = document.createElement('tr');
    headers.forEach(h => { const th = document.createElement('th'); th.textContent = h; tr.appendChild(th); });
    thead.appendChild(tr);
    table.appendChild(thead);
    table.appendChild(document.createElement('tbody'));
    return table;
}

function renderCustomersTable(list){
    const container = document.getElementById('customersSection');
    container.innerHTML = '';
    if(list.length === 0){
        container.innerHTML = '<p style="color:#999; padding:1rem; text-align:center;">Không có dữ liệu</p>';
        return;
    }
    const table = createTable(['Mã KH','Tên khách hàng','Điện thoại','Địa chỉ','Ghi chú','CSKH']);
    const tbody = table.querySelector('tbody');
    list.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c.id||'-'}</td><td>${c.name||'-'}</td><td>${c.phone||'-'}</td><td>${c.address||'-'}</td><td>${c.note||''}</td><td>${c.cskh||'-'}</td>`;
        tbody.appendChild(tr);
    });
    container.appendChild(table);
}

function renderNotesTable(list){
    const container = document.getElementById('notesSection');
    container.innerHTML = '';
    if(list.length === 0){
        container.innerHTML = '<p style="color:#999; padding:1rem; text-align:center;">Không có dữ liệu</p>';
        return;
    }
    const table = createTable(['Khách hàng','Ngày','Nội dung']);
    const tbody = table.querySelector('tbody');
    list.forEach(n => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${n.customerId||'-'}</td><td>${n.date||'-'}</td><td>${n.content||'-'}</td>`;
        tbody.appendChild(tr);
    });
    container.appendChild(table);
}

function renderAppointmentsTable(list){
    const container = document.getElementById('appointmentsSection');
    container.innerHTML = '';
    if(list.length === 0){
        container.innerHTML = '<p style="color:#999; padding:1rem; text-align:center;">Không có dữ liệu</p>';
        return;
    }
    const table = createTable(['Khách hàng','Công việc','Trạng thái','Bắt đầu','Kết thúc']);
    const tbody = table.querySelector('tbody');
    list.forEach(a => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${a.customerId||'-'}</td><td>${a.task||'-'}</td><td>${a.status||'-'}</td><td>${a.start||'-'}</td><td>${a.end||'-'}</td>`;
        tbody.appendChild(tr);
    });
    container.appendChild(table);
}

async function doSearch(){
    const phone = document.getElementById('phoneInput').value.trim();
    if(!phone){
        alert('Vui lòng nhập số điện thoại');
        return;
    }
    
    const searchBtn = document.getElementById('searchBtn');
    const searchInfo = document.getElementById('searchInfo');
    searchBtn.disabled = true;
    searchBtn.textContent = 'Đang tìm...';
    searchInfo.style.display = 'none';
    
    try {
        const response = await fetch(`/api/tra_cuu_khach_hang?phoneNumber=${encodeURIComponent(phone)}`);
        const data = await response.json();
        
        // Hiển thị thời gian tra cứu
        if(data.searchTime){
            document.getElementById('searchTimeText').textContent = data.searchTime;
            if(data.responseTimeFormatted){
                document.getElementById('responseTimeText').textContent = data.responseTimeFormatted;
            }
            searchInfo.style.display = 'block';
        }
        
        if(data.error){
            alert(data.error);
            customers = [];
            notes = [];
            appointments = [];
        } else {
            customers = data.customers || [];
            notes = data.notes || [];
            appointments = data.appointments || [];
        }
        
        renderCustomersTable(customers);
        renderNotesTable(notes);
        renderAppointmentsTable(appointments);
    } catch(error){
        console.error('Error:', error);
        alert('Lỗi khi tìm kiếm: ' + error.message);
    } finally {
        searchBtn.disabled = false;
        searchBtn.textContent = 'Tra cứu';
    }
}

function clearFilter(){
    document.getElementById('phoneInput').value = '';
    customers = [];
    notes = [];
    appointments = [];
    renderCustomersTable([]);
    renderNotesTable([]);
    renderAppointmentsTable([]);
}

function setupToggles(){
    document.querySelectorAll('.toggle-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
            const target = document.getElementById(btn.dataset.target);
            if(!target) return;
            target.classList.toggle('collapsed');
            btn.textContent = target.classList.contains('collapsed') ? '+' : '−';
        });
    });
}

document.getElementById('searchBtn').addEventListener('click', doSearch);
document.getElementById('phoneInput').addEventListener('keydown', (e)=>{ if(e.key === 'Enter') doSearch(); });
document.getElementById('clearBtn').addEventListener('click', clearFilter);

// init
setupToggles();
        </script>
</body>
</html>